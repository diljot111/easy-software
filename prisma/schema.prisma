generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EMPLOYEE
  EASY_TEAM
  CUSTOMER
}

// --------------------------------------
// ğŸ‘¤ USER TABLE
// --------------------------------------
model user {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  phone         String?
  password      String
  role          Role     @default(EMPLOYEE)
  
  // ğŸ”¹ CHANGED: tenant_id is now Int to match tenant.id
  tenant_id     Int?
  created_by_id Int?
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  // ğŸ”¹ Relations
  tenant        tenant?  @relation(fields: [tenant_id], references: [id])
  created_by    user?    @relation("UserCreator", fields: [created_by_id], references: [id])
  created_users user[]   @relation("UserCreator")
  
  login_activities login_activity[]
}

// --------------------------------------
// ğŸ¢ TENANT TABLE
// --------------------------------------
model tenant {
  // ğŸ”¹ CHANGED: From String/cuid to Int/autoincrement
  id              Int      @id @default(autoincrement())
  
  business_name   String
  business_type   String?
  business_phone  String?
  
  db_host         String
  db_user         String
  db_password     String   // Kept your original field name
  db_name         String
  db_port         String?
  
  meta_token      String?  @db.Text
  waba_id         String?
  phone_number_id String?

  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt

  // ğŸ”¹ Relations
  users              user[]
  automation_rules   automation_rule[]
  automation_logs    automation_log[]
  
  // âœ… ADDED: Missing relation array for whatsapp_template
  whatsapp_templates whatsapp_template[] 
}

// --------------------------------------
// ğŸ¤– AUTOMATION RULE TABLE
// --------------------------------------
model automation_rule {
  // ğŸ”¹ CHANGED: From String/cuid to Int/autoincrement
  id            Int      @id @default(autoincrement())
  
  // ğŸ”¹ CHANGED: Relation key is now Int
  tenant_id     Int
  event_type    String
  template_name String
  delay_value   Int      @default(0)
  delay_unit    String   @default("Minutes")
  is_active     Boolean  @default(true)

  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  
  // ğŸ”¹ Relations
  tenant        tenant   @relation(fields: [tenant_id], references: [id])
  logs          automation_log[]
}

// --------------------------------------
// ğŸ“œ AUTOMATION LOG TABLE
// --------------------------------------
model automation_log {
  // ğŸ”¹ CHANGED: From String/cuid to Int/autoincrement
  id            Int      @id @default(autoincrement())
  
  // ğŸ”¹ CHANGED: Relation keys are now Int
  tenant_id     Int
  rule_id       Int
  external_id   String
  status        String
  
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt
  
  // ğŸ”¹ Relations
  tenant        tenant          @relation(fields: [tenant_id], references: [id])
  rule          automation_rule @relation(fields: [rule_id], references: [id])
}

// --------------------------------------
// ğŸ‘¥ CLIENT TABLE (Already correct)
// --------------------------------------
model client {
  id         Int      @id @default(autoincrement())
  name       String?  @db.VarChar(111)
  cont       String?  @db.VarChar(111)
  email      String?  @db.VarChar(111)
  active     Int?     @default(0)
  
  branch_id  Int      @default(1)
  doj        DateTime @default(now()) @db.Timestamp(0)
  updated_at DateTime @default(now()) @updatedAt
}

// --------------------------------------
// ğŸ” LOGIN ACTIVITY TABLE (Already correct)
// --------------------------------------
model login_activity {
  id         Int      @id @default(autoincrement())
  
  user_id    Int
  ip         String
  device     String
  date_time  DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  
  // ğŸ”¹ Relation
  user       user     @relation(fields: [user_id], references: [id])
}
// --------------------------------------
// ğŸ§© SYSTEM TEMPLATES
// --------------------------------------
model system_template {
  id              Int      @id @default(autoincrement())
  
  name            String   
  label           String   
  category        String   
  industry        String   
  components      Json     
  
  // âœ… ADDED: Column to store variable count
  total_variables Int      @default(0)
  
  created_at      DateTime @default(now())

  @@map("system_template")
}
// --------------------------------------
// ğŸ’¬ WHATSAPP TEMPLATE (Synced from Meta)
// --------------------------------------
model whatsapp_template {
  id              Int      @id @default(autoincrement())
  tenant_id       Int
  name            String
  status          String   
  category        String
  language        String
  components      Json
  
  total_variables Int      @default(0)
  
  // âœ… NEW: Store the dropdown selections and backend status
  mappings        Json?    
  is_mapped       Int      @default(0) 
  
  updated_at      DateTime @updatedAt

  tenant          tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, name]) 
}